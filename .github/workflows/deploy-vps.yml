name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Docker Build and Publish"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: DEV_ENV
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.APP_DIR || '/opt/my-scheduler-app' }}

            # Pull the latest .env file from secure location if needed
            # cp /path/to/secure/.env .env

            # Login to Docker Hub if needed
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            # Pull the latest image
            docker-compose pull

            # Update the container with auto-restart policy
            docker-compose down
            docker-compose up -d --remove-orphans

            # Ensure containers have restart policy
            docker update --restart=unless-stopped $(docker-compose ps -q) 2>/dev/null || true

            # Clean up old images
            docker image prune -af --filter "until=24h"

            # Wait for application to start
            echo "Waiting for application to start..."
            sleep 15

            # Check container status
            echo "=== Container Status ==="
            docker-compose ps

            # Run diagnostics if available
            if [[ -f scripts/deployment-diagnostics.sh ]]; then
              echo "=== Running Deployment Diagnostics ==="
              chmod +x scripts/deployment-diagnostics.sh
              ./scripts/deployment-diagnostics.sh
            else
              echo "=== Basic Health Check ==="
              curl -s --retry 5 --retry-delay 5 --retry-connrefused http://localhost:3000/api/health || echo "Health check failed"
            fi

            # Setup systemd service for auto-start on boot
            echo "=== Setting up auto-start service ==="
            sudo tee /etc/systemd/system/my-scheduler-app.service > /dev/null << 'EOF'
            [Unit]
            Description=My Scheduler App
            Requires=docker.service
            After=docker.service
            
            [Service]
            Type=oneshot
            RemainAfterExit=yes
            WorkingDirectory=${{ secrets.APP_DIR || '/opt/my-scheduler-app' }}
            ExecStart=/usr/local/bin/docker-compose up -d
            ExecStop=/usr/local/bin/docker-compose down
            TimeoutStartSec=0
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
            # Enable and start the service
            sudo systemctl daemon-reload
            sudo systemctl enable my-scheduler-app.service
            echo "Auto-start service configured successfully"

      - name: Send notification on success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: deployments
          SLACK_COLOR: good
          SLACK_TITLE: Deployment Successful
          SLACK_MESSAGE: "Application has been successfully deployed to VPS"
          SLACK_FOOTER: "GitHub Actions"

      - name: Send notification on failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: deployments
          SLACK_COLOR: danger
          SLACK_TITLE: Deployment Failed
          SLACK_MESSAGE: "Failed to deploy application to VPS"
          SLACK_FOOTER: "GitHub Actions"
